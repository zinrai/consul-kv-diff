# consul-kv-diff

A command-line tool to compare local KV JSON files with Consul KV store and detect differences.

## Overview

`consul-kv-diff` compares JSON files in the `consul kv export` format with the actual values in Consul KV store to detect:

- Modified keys (different values between local and Consul)
- Keys that exist only in Consul

The tool accepts JSON files in the standard Consul KV export format, which can be generated by:

- `consul kv export` command
- [consul-kv-syncer](https://github.com/zinrai/consul-kv-syncer) with `-export` option
- Any tool that outputs JSON in the Consul KV format

This tool is useful for:

- Pre-deployment validation in CI/CD pipelines
- Monitoring configuration drift
- Ensuring configuration consistency

## Installation

```bash
$ go install github.com/zinrai/consul-kv-diff@latest
```

## Usage

### Basic Usage

Compare a local JSON file with Consul:

```bash
$ consul-kv-diff -local export.json
```

The JSON file should be in the Consul KV export format:

```json
[
  {
    "key": "app/server/host",
    "value": "MC4wLjAuMA=="
  },
  {
    "key": "app/server/port",
    "value": "ODA4MA=="
  }
]
```

Note: Values must be base64-encoded.

### Examples

Export from `consul-kv-syncer` and compare:

```bash
$ consul-kv-syncer -env production -export > production.json
$ consul-kv-diff -local production.json
```

Compare with a specific Consul server:

```bash
$ consul-kv-diff -local export.json -consul-addr http://consul.example.com:8500
```

Compare with a different datacenter:

```bash
$ consul-kv-diff -local export.json -datacenter us-west-1
```

Compare only a specific prefix:

```bash
$ consul-kv-diff -local export.json -prefix app/production
```

## Output

The tool outputs differences to stdout and exits with:

- Exit code 0: No differences found
- Exit code 1: Differences found or error occurred

### Example Output

```
=== Modified Keys ===
Key: app/server/port
  Local:  ODA4MA==
  Consul: OTA5MA==

Key: app/logging/level
  Local:  aW5mbw==
  Consul: d2Fybg==

=== Keys Only in Consul ===
- app/new-feature/enabled
- app/deprecated/flag
```

## License

This project is licensed under the MIT License - see the [LICENSE](https://opensource.org/license/mit) for details.
